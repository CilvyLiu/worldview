import pandas as pd
import akshare as ak
import streamlit as st
import io
from datetime import datetime

# ==================== 1. æ±ªæ±ªé˜Ÿ 28 åªæ ¸å¿ƒæ ‡çš„ ====================
WANGWANG_LIST = [
    {"æˆ˜é˜Ÿ": "ğŸ›¡ï¸ å‹èˆ±çŸ³", "åç§°": "ä¸­å›½ç¥å", "ä»£ç ": "601088"},
    {"æˆ˜é˜Ÿ": "ğŸ›¡ï¸ å‹èˆ±çŸ³", "åç§°": "é•¿æ±Ÿç”µåŠ›", "ä»£ç ": "600900"},
    {"æˆ˜é˜Ÿ": "ğŸ›¡ï¸ å‹èˆ±çŸ³", "åç§°": "å·¥å•†é“¶è¡Œ", "ä»£ç ": "601398"},
    {"æˆ˜é˜Ÿ": "ğŸ›¡ï¸ å‹èˆ±çŸ³", "åç§°": "ä¸­å›½çŸ³æ²¹", "ä»£ç ": "601857"},
    {"æˆ˜é˜Ÿ": "ğŸ›¡ï¸ å‹èˆ±çŸ³", "åç§°": "å†œä¸šé“¶è¡Œ", "ä»£ç ": "601288"},
    {"æˆ˜é˜Ÿ": "ğŸ›¡ï¸ å‹èˆ±çŸ³", "åç§°": "é™•è¥¿ç…¤ä¸š", "ä»£ç ": "601225"},
    {"æˆ˜é˜Ÿ": "ğŸ›¡ï¸ å‹èˆ±çŸ³", "åç§°": "ä¸­å›½å»ºç­‘", "ä»£ç ": "601668"},
    {"æˆ˜é˜Ÿ": "âš”ï¸ å†²é”‹é˜Ÿ", "åç§°": "ä¸œæ–¹è´¢å¯Œ", "ä»£ç ": "300059"},
    {"æˆ˜é˜Ÿ": "âš”ï¸ å†²é”‹é˜Ÿ", "åç§°": "ä¸­ä¿¡è¯åˆ¸", "ä»£ç ": "600030"},
    {"æˆ˜é˜Ÿ": "âš”ï¸ å†²é”‹é˜Ÿ", "åç§°": "å®å¾·æ—¶ä»£", "ä»£ç ": "300750"},
    {"æˆ˜é˜Ÿ": "âš”ï¸ å†²é”‹é˜Ÿ", "åç§°": "æ¯”äºšè¿ª", "ä»£ç ": "002594"},
    {"æˆ˜é˜Ÿ": "âš”ï¸ å†²é”‹é˜Ÿ", "åç§°": "å·¥ä¸šå¯Œè”", "ä»£ç ": "601138"},
    {"æˆ˜é˜Ÿ": "âš”ï¸ å†²é”‹é˜Ÿ", "åç§°": "ä¸­ä¿¡å»ºæŠ•", "ä»£ç ": "601066"},
    {"æˆ˜é˜Ÿ": "âš”ï¸ å†²é”‹é˜Ÿ", "åç§°": "æ³¸å·è€çª–", "ä»£ç ": "000568"},
    {"æˆ˜é˜Ÿ": "ğŸ—ï¸ ç¨³å¢é•¿", "åç§°": "ç´«é‡‘çŸ¿ä¸š", "ä»£ç ": "601899"},
    {"æˆ˜é˜Ÿ": "ğŸ—ï¸ ç¨³å¢é•¿", "åç§°": "ä¸‡ååŒ–å­¦", "ä»£ç ": "600309"},
    {"æˆ˜é˜Ÿ": "ğŸ—ï¸ ç¨³å¢é•¿", "åç§°": "æµ·èºæ°´æ³¥", "ä»£ç ": "600585"},
    {"æˆ˜é˜Ÿ": "ğŸ—ï¸ ç¨³å¢é•¿", "åç§°": "ä¸‰ä¸€é‡å·¥", "ä»£ç ": "600031"},
    {"æˆ˜é˜Ÿ": "ğŸ—ï¸ ç¨³å¢é•¿", "åç§°": "å®é’¢è‚¡ä»½", "ä»£ç ": "600019"},
    {"æˆ˜é˜Ÿ": "ğŸ—ï¸ ç¨³å¢é•¿", "åç§°": "ä¸­å›½ä¸­é“", "ä»£ç ": "601390"},
    {"æˆ˜é˜Ÿ": "ğŸ—ï¸ ç¨³å¢é•¿", "åç§°": "ä¸­å›½ç”µå»º", "ä»£ç ": "601669"},
    {"æˆ˜é˜Ÿ": "ğŸ“ˆ å®ˆæŠ¤è€…", "åç§°": "æ‹›å•†é“¶è¡Œ", "ä»£ç ": "600036"},
    {"æˆ˜é˜Ÿ": "ğŸ“ˆ å®ˆæŠ¤è€…", "åç§°": "ä¸­å›½å¹³å®‰", "ä»£ç ": "601318"},
    {"æˆ˜é˜Ÿ": "ğŸ“ˆ å®ˆæŠ¤è€…", "åç§°": "è´µå·èŒ…å°", "ä»£ç ": "600519"},
    {"æˆ˜domain": "ğŸ“ˆ å®ˆæŠ¤è€…", "åç§°": "äº”ç²®æ¶²", "ä»£ç ": "000858"},
    {"æˆ˜é˜Ÿ": "ğŸ“ˆ å®ˆæŠ¤è€…", "åç§°": "ç¾çš„é›†å›¢", "ä»£ç ": "000333"},
    {"æˆ˜é˜Ÿ": "ğŸ“ˆ å®ˆæŠ¤è€…", "åç§°": "å…´ä¸šé“¶è¡Œ", "ä»£ç ": "601166"},
    {"æˆ˜é˜Ÿ": "ğŸ“ˆ å®ˆæŠ¤è€…", "åç§°": "æ ¼åŠ›ç”µå™¨", "ä»£ç ": "000651"}
]

# ==================== 2. UI ç•Œé¢ ====================
def main():
    st.set_page_config(page_title="Nova æ±ªæ±ªé˜Ÿæ¢æµ‹å™¨", layout="wide")
    st.title("ğŸ¹ Nova æ±ªæ±ªé˜Ÿå…¨æ¡ˆæ¢æµ‹ç³»ç»Ÿ")

    # --- ä¾§è¾¹æ ï¼šå‚æ•°å¹²é¢„ (è¿™æ˜¯å®è§‚é¢çš„æ ¸å¿ƒæ¥æº) ---
    with st.sidebar:
        st.header("âš™ï¸ å®è§‚é¢æ‰‹åŠ¨å¹²é¢„")
        user_gdp = st.number_input("1. æ‰‹åŠ¨è¾“å…¥ GDP (äº¿å…ƒ):", value=1300000, step=10000)
        user_mv = st.number_input("2. æ‰‹åŠ¨è¾“å…¥ Aè‚¡æ€»å¸‚å€¼ (äº¿å…ƒ):", value=850000, step=10000)
        user_pmi = st.slider("3. PMI è£æ¯å€¼è®¾å®š:", 45.0, 55.0, 50.1)
        user_m1 = st.slider("4. M1 å¢é€Ÿå·®è®¾å®š:", -5.0, 5.0, 0.5)
        st.divider()
        run_scan = st.button("ğŸš€ å¼€å¯ 28 åªå…¨æ¿å—ä¸»åŠ›æ¢æµ‹", use_container_width=True)

    # --- 3. åŠ¨æ€æŒ‡æ ‡è®¡ç®— (ä¸è°ƒç”¨æ¥å£ï¼Œç›´æ¥ç”¨è¾“å…¥å€¼) ---
    buffett_val = (user_mv / user_gdp) * 100 if user_gdp > 0 else 0
    
    # é£æ ¼åˆ¤å®šé€»è¾‘
    style = "ğŸ” éœ‡è¡æ ¼å±€"
    if user_pmi > 50 and user_m1 > 0: style = "ğŸš€ æ‰©å¼ ç‚¹ç« (é¡ºå‘¨æœŸ)"
    elif user_pmi < 50 and user_m1 < 0: style = "ğŸ›¡ï¸ ç¼©è¡¨é˜²å¾¡ (çº¢åˆ©ä½ä¼°)"
    elif buffett_val < 65: style = "ğŸ’ åº•éƒ¨åè½¬åŒºåŸŸ"

    # --- 4. é¡¶éƒ¨ä»ªè¡¨ç›˜ ---
    
    c1, c2, c3, c4 = st.columns(4)
    c1.metric("å·´è²ç‰¹æŒ‡æ ‡", f"{round(buffett_val, 2)}%", f"{'ä½ä¼°' if buffett_val < 75 else 'é«˜ä¼°'}")
    c2.metric("PMI è®¾å®šå€¼", user_pmi, f"{round(user_pmi-50, 2)}")
    c3.metric("M1 æ´»æ€§å¢é‡", f"{user_m1}%")
    c4.metric("å½“å‰é£æ ¼å–å‘", style)

    st.divider()

    # --- 5. æ±ªæ±ªé˜Ÿæ¢æµ‹æŠ¥å‘Š ---
    if run_scan:
        with st.spinner("æ­£åœ¨å¼ºåˆ¶ç©¿é€ 28 åªæ ‡çš„æ•°æ®å£å¾„..."):
            results = []
            # è¿™é‡Œçš„æ¥å£è°ƒç”¨æ˜¯æœ€åä¸€é“é˜²çº¿
            try:
                # å°è¯•ä¸€æ¬¡æ€§è·å–ä¸ªè‚¡å¿«ç…§ï¼Œå¦‚æœå¤±è´¥åˆ™èµ°ä¸ªè‚¡éå†
                spot_df = ak.stock_zh_a_spot_em()
            except:
                spot_df = pd.DataFrame()

            progress_text = st.empty()
            pb = st.progress(0)

            for i, stock in enumerate(WANGWANG_LIST):
                progress_text.text(f"æ­£åœ¨æ¢æµ‹: {stock['åç§°']} ({stock['ä»£ç ']})")
                data = {"pct": 0.0, "turnover": 0.0}
                
                # å£å¾„ Aï¼šå¤§è¡¨åŒ¹é…
                if not spot_df.empty:
                    row = spot_df[spot_df['ä»£ç '] == stock['ä»£ç ']]
                    if not row.empty:
                        data["pct"] = float(row['æ¶¨è·Œå¹…'].values[0])
                        data["turnover"] = float(row['æˆäº¤é¢'].values[0])
                
                # å£å¾„ Bï¼šè‹¥å¤§è¡¨å¤±è´¥ï¼Œå°è¯•å†å²å•å…µæ¥å£ (æœ€åä¸€å¤©)
                if data["pct"] == 0.0:
                    try:
                        hist = ak.stock_zh_a_hist(symbol=stock['ä»£ç '], period="daily", adjust="qfq").iloc[-1:]
                        data["pct"] = float(hist['æ¶¨è·Œå¹…'].values[0])
                        data["turnover"] = float(hist['æˆäº¤é¢'].values[0])
                    except: pass
                
                results.append({
                    "æˆ˜é˜Ÿåˆ†ç±»": stock['æˆ˜é˜Ÿ'],
                    "æ ‡çš„åç§°": stock['åç§°'],
                    "ä»£ç ": stock['ä»£ç '],
                    "å®æ—¶æ¶¨å¹…%": data["pct"],
                    "æˆäº¤é¢(äº¿)": round(data["turnover"] / 1e8, 2)
                })
                pb.progress((i + 1) / len(WANGWANG_LIST))
            
            df = pd.DataFrame(results)
            progress_text.empty()

            if not df.empty:
                # ç®€å•åŠ¨å‘åˆ¤å®š
                df['ä¸»åŠ›åŠ¨å‘'] = df.apply(lambda x: "ğŸ”¥ å¼ºåŠ›ä»‹å…¥" if x['å®æ—¶æ¶¨å¹…%'] > 1.2 else ("ğŸ›¡ï¸ æŠ¤ç›˜æ”¯æ’‘" if -0.2 < x['å®æ—¶æ¶¨å¹…%'] < 0.2 and x['æˆäº¤é¢(äº¿)'] > 5 else "âšª æ­£å¸¸è·Ÿéš"), axis=1)

                # å±•ç¤ºä¸å¯¼å‡º
                v1, v2 = st.columns([1, 2])
                with v1:
                    st.write("ğŸ“ˆ ä¸»åŠ›ä»‹å…¥åˆ†å¸ƒ")
                    st.bar_chart(df['ä¸»åŠ›åŠ¨å‘'].value_counts())
                with v2:
                    st.write("ğŸ’° æˆ˜é˜Ÿèµ„é‡‘æµé‡")
                    st.bar_chart(df.groupby('æˆ˜é˜Ÿåˆ†ç±»')['æˆäº¤é¢(äº¿)'].sum())

                st.subheader("ğŸ“‹ è¯¦ç»†ä½œæˆ˜æŠ¥å‘Š")
                st.dataframe(df.style.background_gradient(subset=['å®æ—¶æ¶¨å¹…%'], cmap='RdYlGn_r'), use_container_width=True)

                # Excel å¯¼å‡º
                output = io.BytesIO()
                with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
                    df.to_excel(writer, index=False, sheet_name='æ±ªæ±ªé˜Ÿæ¢æµ‹')
                st.sidebar.download_button("ğŸ“¥ å¯¼å‡ºä½œæˆ˜ Excel", output.getvalue(), "Nova_Report.xlsx")
            else:
                st.error("æ‰€æœ‰å–æ•°å£å¾„å‡å‘Šå¤±è´¥ã€‚å¯èƒ½æ˜¯ç”±äºèŠ‚å‡æ—¥æ— è¡Œæƒ…æ•°æ®ï¼Œæˆ–é˜²ç«å¢™å½»åº•å°é”ã€‚")
    else:
        st.info("ğŸ‘‹ Novaï¼Œæˆ‘å·²ç»å°†å®è§‚é¢æ”¹ä¸º**æ‰‹åŠ¨å¹²é¢„æ¨¡å¼**ä»¥è§„é¿æ¥å£å°ç¦ã€‚è¯·åœ¨å·¦ä¾§è°ƒæ•´å‚æ•°åç‚¹å‡»â€˜å¼€å¯æ¢æµ‹â€™ã€‚")

if __name__ == "__main__":
    main()

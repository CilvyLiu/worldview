import pandas as pd
import akshare as ak
import streamlit as st
import io
from datetime import datetime

# ==================== 1. æ ¸å¿ƒæ ‡çš„ä»£ç æ˜ å°„ ====================
WANGWANG_MAP = [
    {"æˆ˜é˜Ÿ": "ğŸ›¡ï¸ å‹èˆ±çŸ³", "åç§°": "ä¸­å›½ç¥å", "ä»£ç ": "601088"},
    {"æˆ˜é˜Ÿ": "ğŸ›¡ï¸ å‹èˆ±çŸ³", "åç§°": "é•¿æ±Ÿç”µåŠ›", "ä»£ç ": "600900"},
    {"æˆ˜é˜Ÿ": "ğŸ›¡ï¸ å‹èˆ±çŸ³", "åç§°": "å·¥å•†é“¶è¡Œ", "ä»£ç ": "601398"},
    {"æˆ˜é˜Ÿ": "ğŸ›¡ï¸ å‹èˆ±çŸ³", "åç§°": "ä¸­å›½çŸ³æ²¹", "ä»£ç ": "601857"},
    {"æˆ˜é˜Ÿ": "ğŸ›¡ï¸ å‹èˆ±çŸ³", "åç§°": "å†œä¸šé“¶è¡Œ", "ä»£ç ": "601288"},
    {"æˆ˜é˜Ÿ": "ğŸ›¡ï¸ å‹èˆ±çŸ³", "åç§°": "é™•è¥¿ç…¤ä¸š", "ä»£ç ": "601225"},
    {"æˆ˜é˜Ÿ": "ğŸ›¡ï¸ å‹èˆ±çŸ³", "åç§°": "ä¸­å›½å»ºç­‘", "ä»£ç ": "601668"},
    {"æˆ˜é˜Ÿ": "âš”ï¸ å†²é”‹é˜Ÿ", "åç§°": "ä¸œæ–¹è´¢å¯Œ", "ä»£ç ": "300059"},
    {"æˆ˜é˜Ÿ": "âš”ï¸ å†²é”‹é˜Ÿ", "åç§°": "ä¸­ä¿¡è¯åˆ¸", "ä»£ç ": "600030"},
    {"æˆ˜é˜Ÿ": "âš”ï¸ å†²é”‹é˜Ÿ", "åç§°": "å®å¾·æ—¶ä»£", "ä»£ç ": "300750"},
    {"æˆ˜é˜Ÿ": "âš”ï¸ å†²é”‹é˜Ÿ", "åç§°": "æ¯”äºšè¿ª", "ä»£ç ": "002594"},
    {"æˆ˜é˜Ÿ": "âš”ï¸ å†²é”‹é˜Ÿ", "åç§°": "å·¥ä¸šå¯Œè”", "ä»£ç ": "601138"},
    {"æˆ˜é˜Ÿ": "âš”ï¸ å†²é”‹é˜Ÿ", "åç§°": "ä¸­ä¿¡å»ºæŠ•", "ä»£ç ": "601066"},
    {"æˆ˜é˜Ÿ": "âš”ï¸ å†²é”‹é˜Ÿ", "åç§°": "æ³¸å·è€çª–", "ä»£ç ": "000568"},
    {"æˆ˜é˜Ÿ": "ğŸ—ï¸ ç¨³å¢é•¿", "åç§°": "ç´«é‡‘çŸ¿ä¸š", "ä»£ç ": "601899"},
    {"æˆ˜é˜Ÿ": "ğŸ—ï¸ ç¨³å¢é•¿", "åç§°": "ä¸‡ååŒ–å­¦", "ä»£ç ": "600309"},
    {"æˆ˜é˜Ÿ": "ğŸ—ï¸ ç¨³å¢é•¿", "åç§°": "æµ·èºæ°´æ³¥", "ä»£ç ": "600585"},
    {"æˆ˜é˜Ÿ": "ğŸ—ï¸ ç¨³å¢é•¿", "åç§°": "ä¸‰ä¸€é‡å·¥", "ä»£ç ": "600031"},
    {"æˆ˜é˜Ÿ": "ğŸ—ï¸ ç¨³å¢é•¿", "åç§°": "å®é’¢è‚¡ä»½", "ä»£ç ": "600019"},
    {"æˆ˜é˜Ÿ": "ğŸ—ï¸ ç¨³å¢é•¿", "åç§°": "ä¸­å›½ä¸­é“", "ä»£ç ": "601390"},
    {"æˆ˜é˜Ÿ": "ğŸ—ï¸ ç¨³å¢é•¿", "åç§°": "ä¸­å›½ç”µå»º", "ä»£ç ": "601669"},
    {"æˆ˜é˜Ÿ": "ğŸ“ˆ å®ˆæŠ¤è€…", "åç§°": "æ‹›å•†é“¶è¡Œ", "ä»£ç ": "600036"},
    {"æˆ˜é˜Ÿ": "ğŸ“ˆ å®ˆæŠ¤è€…", "åç§°": "ä¸­å›½å¹³å®‰", "ä»£ç ": "601318"},
    {"æˆ˜é˜Ÿ": "ğŸ“ˆ å®ˆæŠ¤è€…", "åç§°": "è´µå·èŒ…å°", "ä»£ç ": "600519"},
    {"æˆ˜é˜Ÿ": "ğŸ“ˆ å®ˆæŠ¤è€…", "åç§°": "äº”ç²®æ¶²", "ä»£ç ": "000858"},
    {"æˆ˜é˜Ÿ": "ğŸ“ˆ å®ˆæŠ¤è€…", "åç§°": "ç¾çš„é›†å›¢", "ä»£ç ": "000333"},
    {"æˆ˜é˜Ÿ": "ğŸ“ˆ å®ˆæŠ¤è€…", "åç§°": "å…´ä¸šé“¶è¡Œ", "ä»£ç ": "601166"},
    {"æˆ˜é˜Ÿ": "ğŸ“ˆ å®ˆæŠ¤è€…", "åç§°": "æ ¼åŠ›ç”µå™¨", "ä»£ç ": "000651"}
]

# ==================== 2. å…¨è‡ªåŠ¨å¢å¼ºå¼•æ“ ====================
class NovaAutoEngine:
    @staticmethod
    def get_market_data():
        """å…¨è‡ªåŠ¨æŠ“å–ï¼šå®è§‚+æŒ‡æ•°+å¸‚å€¼"""
        # é»˜è®¤ä¿åº•å€¼ (2026å¹´åŸºå‡†)
        data = {"PMI": 50.1, "M1": 0.5, "HS300": 0.0, "Total_MV": 860000.0}
        
        try:
            # 1. æŒ‡æ•°å…¨æŠ“å–
            idx_df = ak.stock_zh_index_spot_em()
            hs300_row = idx_df[idx_df['åç§°'] == 'æ²ªæ·±300']
            if not hs300_row.empty:
                data["HS300"] = float(hs300_row['æ¶¨è·Œå¹…'].values[0])
            
            # 2. å¸‚å€¼è‡ªåŠ¨æŠ“å–
            mv_df = ak.stock_a_total_value()
            data["Total_MV"] = float(mv_df.iloc[-1]['total_value'])
            
            # 3. å®è§‚æ•°æ®
            pmi_df = ak.macro_china_pmi()
            data["PMI"] = float(pmi_df.iloc[-1]['value'])
        except Exception as e:
            st.warning(f"âš ï¸ éƒ¨åˆ†è‡ªåŠ¨å£å¾„å—é™ (æµ·å¤–IP/éäº¤æ˜“æ—¶é—´)ï¼Œå·²å¯ç”¨é€»è¾‘ä¿åº•ã€‚")
        
        return data

# ==================== 3. UI ç•Œé¢ ====================
def main():
    st.set_page_config(page_title="Nova æ¢æµ‹å™¨ 2026", layout="wide")
    
    # åˆå§‹åŒ–è‡ªåŠ¨æ•°æ®
    auto_data = NovaAutoEngine.get_market_data()

    st.title("ğŸ¹ Nova æ±ªæ±ªé˜Ÿå…¨è‡ªåŠ¨æ¢æµ‹ç³»ç»Ÿ")

    with st.sidebar:
        st.header("âš™ï¸ è‡ªåŠ¨åŒ–ä¿®æ­£")
        # GDP è¿˜æ˜¯å¾—ä½ ç¡®è®¤ä¸€ä¸‹ï¼Œæ¯•ç«Ÿé‚£æ˜¯ä½ çš„â€œç®—åŠ›åˆ†æ¯â€
        gdp = st.number_input("1. GDP åˆ†æ¯ (äº¿å…ƒ):", value=1300000)
        
        # æŒ‡æ•°ä¿®æ­£ (å¦‚æœè‡ªåŠ¨æŠ“å–å¤±è´¥ï¼Œä½ å¯ä»¥åœ¨è¿™æ‰‹åŠ¨æ”¹)
        st.divider()
        st.subheader("ğŸ“Š æŒ‡æ•°æ‰‹åŠ¨çº å")
        fix_hs300 = st.number_input("æ²ªæ·±300æ¶¨å¹…(%) [è‡ªåŠ¨åŒæ­¥ä¸­]:", value=auto_data["HS300"])
        
        st.divider()
        run_scan = st.button("ğŸš€ å¼€å¯ 28 åªå…¨æ¿å—ç©¿é€", use_container_width=True)

    # æ ¸å¿ƒæŒ‡æ ‡å±•ç¤º
    
    buffett_val = (auto_data["Total_MV"] / gdp) * 100
    
    c1, c2, c3, c4 = st.columns(4)
    c1.metric("å·´è²ç‰¹æŒ‡æ ‡ (è‡ªåŠ¨)", f"{round(buffett_val, 2)}%", f"{round(auto_data['Total_MV']/10000, 1)}ä¸‡äº¿")
    c2.metric("PMI è£æ¯çº¿", auto_data["PMI"], f"{round(auto_data['PMI']-50, 1)}")
    c3.metric("æ²ªæ·±300å‚è€ƒ", f"{fix_hs300}%")
    
    style = "ğŸ’ åº•éƒ¨ä»·å€¼" if buffett_val < 65 else "âš–ï¸ å‡è¡¡åšå¼ˆ"
    if auto_data["PMI"] > 50: style = "ğŸš€ æ‰©å¼ ç‚¹ç«"
    c4.metric("é£æ ¼åˆ¤å®š", style)

    st.divider()

    if run_scan:
        with st.spinner("æ­£åœ¨ç‚¹åæ¢æµ‹ 28 åªæ ¸å¿ƒæ ‡çš„..."):
            # é‡‡ç”¨ä½ ç»™çš„ SuperEngine é€»è¾‘ï¼Œä½†åŠ å…¥æ›´å¼ºçš„ç©ºå€¼å¤„ç†
            results = []
            try:
                spot_df = ak.stock_zh_a_spot_em()
            except:
                spot_df = pd.DataFrame()

            for s in WANGWANG_MAP:
                # ä¼˜å…ˆçº§ 1: å®æ—¶å¿«ç…§
                row = spot_df[spot_df['ä»£ç '] == s['ä»£ç ']] if not spot_df.empty else pd.DataFrame()
                
                if not row.empty:
                    pct = float(row['æ¶¨è·Œå¹…'].values[0])
                    turnover = float(row['æˆäº¤é¢'].values[0])
                else:
                    # ä¼˜å…ˆçº§ 2: å†å²æ¥å£å›æº¯æœ€è¿‘ä¸€åˆ†é’Ÿ
                    try:
                        hist = ak.stock_zh_a_hist(symbol=s['ä»£ç '], period="daily", adjust="qfq").iloc[-1:]
                        pct = float(hist['æ¶¨è·Œå¹…'].values[0])
                        turnover = float(hist['æˆäº¤é¢'].values[0])
                    except:
                        pct, turnover = 0.0, 0.0

                results.append({
                    "æˆ˜é˜Ÿåˆ†ç±»": s['æˆ˜é˜Ÿ'], "åç§°": s['åç§°'], "æ¶¨å¹…%": pct,
                    "è¶…é¢æ”¶ç›Š%": round(pct - fix_hs300, 2),
                    "æˆäº¤é¢(äº¿)": round(turnover/1e8, 2)
                })

            df = pd.DataFrame(results)
            
            if not df.empty:
                # æ±ªæ±ªé˜Ÿé€»è¾‘åˆ¤å®š
                df['ä¸»åŠ›åŠ¨å‘'] = df.apply(lambda x: 
                    "ğŸ”¥ å¼ºåŠ›æ‰«è´§" if x['è¶…é¢æ”¶ç›Š%'] > 1.2 else (
                    "ğŸ›¡ï¸ æŠ¤ç›˜æ”¯æ’‘" if x['è¶…é¢æ”¶ç›Š%'] >= 0 and fix_hs300 < -0.3 else "âšª æ­£å¸¸è·Ÿéš"
                ), axis=1)

                # æ•°æ®å¯è§†åŒ–
                st.subheader("ğŸ“‹ æ±ªæ±ªé˜Ÿå®æ—¶åŠ¨å‘ç©¿é€")
                st.dataframe(df.style.background_gradient(subset=['æ¶¨å¹…%'], cmap='RdYlGn_r'), use_container_width=True)

                # æˆ˜é˜Ÿæ±‡æ€»
                st.write("ğŸ’° æˆ˜é˜Ÿèµ„é‡‘æ´»è·ƒåº¦å¯¹æ¯”")
                st.bar_chart(df.groupby('æˆ˜é˜Ÿåˆ†ç±»')['æˆäº¤é¢(äº¿)'].sum())
            else:
                st.error("ğŸš¨ æ¢æµ‹å™¨æ‰€æœ‰è·¯å¾„å‡è¢«å°é”ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æ›´æ¢æœ¬åœ°è¿è¡Œç¯å¢ƒã€‚")

if __name__ == "__main__":
    main()
